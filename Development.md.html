<!DOCTYPE html><html><head><meta charset="utf-8"><title>Development.md</title><style></style></head><body id="preview">
<h1 class="code-line" data-line-start=0 data-line-end=1><a id="Development_0"></a>Development</h1>
<h2 class="code-line" data-line-start=2 data-line-end=3><a id="Setting_up_the_solution_2"></a>Setting up the solution</h2>
<p class="has-line-data" data-line-start="4" data-line-end="5">We are starting right at the beginning. At first you’ll need a solution to place the project in.</p>
<p class="has-line-data" data-line-start="6" data-line-end="8">Navigate to a directory where you want the source to be in. For me it is <code>C:\Repos\Azure\Kaush</code>.<br>
Open a console and type <code>dotnet new sln</code>, which will create a solution file. Open it. I am using Visual Studio 2022 Community Edition as the IDE of my choice.</p>
<p class="has-line-data" data-line-start="9" data-line-end="11">Add a new Project.<br>
<img src="/images/01_add_new_proj.png" alt=""></p>
<p class="has-line-data" data-line-start="12" data-line-end="14">Search for <code>Azure Functions</code> like so:<br>
<img src="/images/02_search_azure_funcs.png" alt=""></p>
<p class="has-line-data" data-line-start="15" data-line-end="16">Hit Next and give a name. I’ll choose <code>SoftDeleteDetection</code>. Hit Next.</p>
<p class="has-line-data" data-line-start="17" data-line-end="19">Fill in the information like here.<br>
You want to use</p>
<ul>
<li class="has-line-data" data-line-start="19" data-line-end="20">.NET6.0 (because it’s the current version)</li>
<li class="has-line-data" data-line-start="20" data-line-end="21">Timer trigger (so that the function gets executed automatically)</li>
<li class="has-line-data" data-line-start="21" data-line-end="22">Azurite (because it’s default)</li>
<li class="has-line-data" data-line-start="22" data-line-end="23">Docker if you want to (optional)</li>
<li class="has-line-data" data-line-start="23" data-line-end="25">Schedule is every 5 Minutes by default. I set it to every Monday at 9 AM. Here’s a <a href="https://arminreiter.com/2017/02/azure-functions-time-trigger-cron-cheat-sheet/">cheat sheet</a></li>
</ul>
<p class="has-line-data" data-line-start="25" data-line-end="26"><img src="/images/03_new_proj_additional_information.png" alt=""></p>
<p class="has-line-data" data-line-start="27" data-line-end="28">Hit Create - The project will be created.</p>
<h2 class="code-line" data-line-start=29 data-line-end=30><a id="Rename_the_function_and_use_file_scoped_namespaces_29"></a>Rename the function and use file scoped namespaces</h2>
<p class="has-line-data" data-line-start="31" data-line-end="32">By default the function will be named <code>Function1</code>, which is not very meaningful. I change it to <code>NotifyOnSoftDeletedResourcesFunctions</code>. Sounds like a lot - but now everyone knows what this function is supposed to do without having to take a look inside.</p>
<p class="has-line-data" data-line-start="33" data-line-end="34">I like to change filenames through the solution explorer - because then a dialog appears asking if the class name should also be changed.</p>
<p class="has-line-data" data-line-start="35" data-line-end="37"><img src="/images/04_rename_through_solution_explorer.png" alt=""><br>
<img src="/images/05_rename_dialog.png" alt=""></p>
<p class="has-line-data" data-line-start="38" data-line-end="39">Your class now looks like this:</p>
<pre><code class="has-line-data" data-line-start="41" data-line-end="58" class="language-csharp"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> Microsoft.Azure.WebJobs;
<span class="hljs-keyword">using</span> Microsoft.Azure.WebJobs.Host;
<span class="hljs-keyword">using</span> Microsoft.Extensions.Logging;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">SoftDeleteDetection</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">NotifyOnSoftDeletedResourcesFunctions</span>
    {
        [FunctionName(<span class="hljs-string">"Function1"</span>)]
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Run</span>(<span class="hljs-params">[TimerTrigger(<span class="hljs-string">"0 0 9 * * MON"</span></span>)]TimerInfo myTimer, ILogger log)
        </span>{
            log.LogInformation($<span class="hljs-string">"C# Timer trigger function executed at: {DateTime.Now}"</span>);
        }
    }
}
</code></pre>
<p class="has-line-data" data-line-start="59" data-line-end="60">A class may contain multiple functions. That is why I pluralized the name - but this is just personal preference.</p>
<p class="has-line-data" data-line-start="61" data-line-end="62">Change the name in the <code>FunctionName</code>-attribute and the method name <code>Run</code> as well to <code>ScanAndNotify</code> - again to have something meaningful.</p>
<pre><code class="has-line-data" data-line-start="64" data-line-end="73" class="language-csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">NotifyOnSoftDeletedResourcesFunctions</span>
    {
        [FunctionName(<span class="hljs-string">"ScanAndNotify"</span>)]
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ScanAndNotify</span>(<span class="hljs-params">[TimerTrigger(<span class="hljs-string">"0 0 9 * * MON"</span></span>)]TimerInfo myTimer, ILogger log)
        </span>{
            log.LogInformation($<span class="hljs-string">"C# Timer trigger function executed at: {DateTime.Now}"</span>);
        }
    }
</code></pre>
<p class="has-line-data" data-line-start="74" data-line-end="75">With dotnet6.0 comes file scoped namespaces. We can switch to that by typing a semicolon behind <code>namespace SoftDeleteDetection</code>.</p>
<p class="has-line-data" data-line-start="76" data-line-end="77">Our code now looks like this:</p>
<pre><code class="has-line-data" data-line-start="78" data-line-end="94" class="language-csharp"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> Microsoft.Azure.WebJobs;
<span class="hljs-keyword">using</span> Microsoft.Azure.WebJobs.Host;
<span class="hljs-keyword">using</span> Microsoft.Extensions.Logging;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">SoftDeleteDetection</span>;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">NotifyOnSoftDeletedResourcesFunctions</span>
{
    [FunctionName(<span class="hljs-string">"ScanAndNotify"</span>)]
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ScanAndNotify</span>(<span class="hljs-params">[TimerTrigger(<span class="hljs-string">"0 0 9 * * MON"</span></span>)]TimerInfo myTimer, ILogger log)
    </span>{
        log.LogInformation($<span class="hljs-string">"C# Timer trigger function executed at: {DateTime.Now}"</span>);
    }
}
</code></pre>
<blockquote>
<p class="has-line-data" data-line-start="95" data-line-end="96">The cron expression from the start is now insite the TimerTrigger(…). Change it as you like.</p>
</blockquote>
<h2 class="code-line" data-line-start=97 data-line-end=98><a id="Settings_97"></a>Settings</h2>
<p class="has-line-data" data-line-start="98" data-line-end="99">We will need to store some settings in our application. For that we have the file <code>local.settings.json</code></p>
<p class="has-line-data" data-line-start="100" data-line-end="101"><img src="/images/06_local_settings_json.png" alt=""></p>
<p class="has-line-data" data-line-start="102" data-line-end="103">Content looks like this:</p>
<pre><code class="has-line-data" data-line-start="104" data-line-end="112" class="language-json">{
    "<span class="hljs-attribute">IsEncrypted</span>": <span class="hljs-value"><span class="hljs-literal">false</span></span>,
    "<span class="hljs-attribute">Values</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">AzureWebJobsStorage</span>": <span class="hljs-value"><span class="hljs-string">"UseDevelopmentStorage=true"</span></span>,
        "<span class="hljs-attribute">FUNCTIONS_WORKER_RUNTIME</span>": <span class="hljs-value"><span class="hljs-string">"dotnet"</span>
    </span>}
</span>}
</code></pre>
<p class="has-line-data" data-line-start="113" data-line-end="114">We want to send an email, so let’s do an example here for report receipents.</p>
<pre><code class="has-line-data" data-line-start="115" data-line-end="124" class="language-json">{
  "<span class="hljs-attribute">IsEncrypted</span>": <span class="hljs-value"><span class="hljs-literal">false</span></span>,
  "<span class="hljs-attribute">Values</span>": <span class="hljs-value">{
      "<span class="hljs-attribute">AzureWebJobsStorage</span>": <span class="hljs-value"><span class="hljs-string">"UseDevelopmentStorage=true"</span></span>,
      "<span class="hljs-attribute">FUNCTIONS_WORKER_RUNTIME</span>": <span class="hljs-value"><span class="hljs-string">"dotnet"</span></span>,
      "<span class="hljs-attribute">ReportReceipents</span>": <span class="hljs-value"><span class="hljs-string">"<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="9af1f5f4eefbf1eedafcf3e9eefff6f7fbf4f4b4feff">[email&#160;protected]</a>;<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="d3bab0bbbbb2b1b9b2bdbaabb1b6a0a0b6a1b6a0a9a6a7a6bd93a4b6b1fdb7b6">[email&#160;protected]</a>"</span>
    </span>}
</span>}
</code></pre>
<p class="has-line-data" data-line-start="125" data-line-end="126">We can access the value inside our code like this:</p>
<pre><code class="has-line-data" data-line-start="127" data-line-end="129" class="language-csharp"><span class="hljs-keyword">string</span> reportReceipents = Environment.GetEnvironmentVariable(<span class="hljs-string">"ReportReceipents"</span>);
</code></pre>
<p class="has-line-data" data-line-start="129" data-line-end="131">Later when you deploy your application to azure you set things like this:<br>
<img src="images/07_preview_of_app_config_in_azure.png" alt=""></p>
<p class="has-line-data" data-line-start="132" data-line-end="133">In order to have an overview of the settings I tend to create a class with properties of settings names.</p>
<pre><code class="has-line-data" data-line-start="135" data-line-end="142" class="language-csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">SoftDeleteDetection.Models</span>;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Settings</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">string</span> ReportReceipents = <span class="hljs-string">"ReportReceipents"</span>;
}
</code></pre>
<p class="has-line-data" data-line-start="143" data-line-end="144">If you do this, you retrieve a setting like this:</p>
<pre><code class="has-line-data" data-line-start="146" data-line-end="148" class="language-csharp"><span class="hljs-keyword">string</span> reportReceipents = Environment.GetEnvironmentVariable(Settings.ReportReceipents);
</code></pre>
<h2 class="code-line" data-line-start=149 data-line-end=150><a id="Setup_Azure_Monitor_149"></a>Setup Azure Monitor</h2>
<p class="has-line-data" data-line-start="151" data-line-end="152">We will use the <a href="https://docs.microsoft.com/en-us/azure/azure-monitor/overview">Azure Monitor</a> resource in order to get information about deletions of Resources and Azure Key Vault entries.</p>
<p class="has-line-data" data-line-start="153" data-line-end="154"><a href="https://docs.microsoft.com/en-us/azure/azure-monitor/logs/data-platform-logs">Azure Monitor Logs</a></p>
<p class="has-line-data" data-line-start="156" data-line-end="157">For it to work properly we have to do some setup.</p>
<ol>
<li class="has-line-data" data-line-start="157" data-line-end="158">Create a log workspace</li>
<li class="has-line-data" data-line-start="158" data-line-end="160">Set Diagnostic settings on resources</li>
</ol>
<p class="has-line-data" data-line-start="160" data-line-end="161"><img src="/docs/images/log%20analytics%20workspace.png" alt=""></p>
<p class="has-line-data" data-line-start="162" data-line-end="163">Create one if not existant.</p>
<p class="has-line-data" data-line-start="164" data-line-end="165">Keep note of the workspace id as you will need it later.</p>
<p class="has-line-data" data-line-start="166" data-line-end="167"><a href="https://portal.azure.com/#view/HubsExtension/BrowseResource/resourceType/Microsoft.OperationalInsights%2Fworkspaces">https://portal.azure.com/#view/HubsExtension/BrowseResource/resourceType/Microsoft.OperationalInsights%2Fworkspaces</a></p>
<p class="has-line-data" data-line-start="168" data-line-end="169"><img src="/docs/images/log%20analytics%20workspace%202.png" alt=""></p>
<p class="has-line-data" data-line-start="170" data-line-end="171">Now that we have a workspace we need to tell our resources to write logs there.</p>
<p class="has-line-data" data-line-start="172" data-line-end="173"><a href="https://portal.azure.com/#view/Microsoft_Azure_Monitoring/AzureMonitoringBrowseBlade/~/diagnosticsLogs">https://portal.azure.com/#view/Microsoft_Azure_Monitoring/AzureMonitoringBrowseBlade/~/diagnosticsLogs</a></p>
<p class="has-line-data" data-line-start="174" data-line-end="175"><img src="/docs/images/diagnostic%20settings.png" alt=""></p>
<p class="has-line-data" data-line-start="176" data-line-end="178">We will do this for our Key Vault resource.<br>
Click on it and you will be redirected to a menu where you can set this up.</p>
<p class="has-line-data" data-line-start="179" data-line-end="180"><img src="/docs/images/add_diagnostic_setting_kv.png" alt=""></p>
<p class="has-line-data" data-line-start="181" data-line-end="182"><img src="/docs/images/configure_diagnostic_setting.png" alt=""></p>
<p class="has-line-data" data-line-start="183" data-line-end="184">Now we will retrieve diagnostic log entries when something important happens to our key vault.</p>
<p class="has-line-data" data-line-start="185" data-line-end="187">The next step is to get important log entries from our activity log.<br>
<a href="https://portal.azure.com/#view/Microsoft_Azure_Monitoring/AzureMonitoringBrowseBlade/~/activityLog">https://portal.azure.com/#view/Microsoft_Azure_Monitoring/AzureMonitoringBrowseBlade/~/activityLog</a></p>
<p class="has-line-data" data-line-start="188" data-line-end="189"><img src="/docs/images/activity_log.png" alt=""></p>
<p class="has-line-data" data-line-start="190" data-line-end="191">Click on <code>Export Activity Logs</code> and set up a Diagnostic setting just like you did for the key vault.</p>
<p class="has-line-data" data-line-start="192" data-line-end="193"><img src="/docs/images/diagnostic_setting_activity_logs.png" alt=""></p>
<p class="has-line-data" data-line-start="194" data-line-end="195">That’s it. We don’t need more than those two.</p>
<h2 class="code-line" data-line-start=196 data-line-end=197><a id="Access_Azure_Monitor_196"></a>Access Azure Monitor</h2>
<p class="has-line-data" data-line-start="198" data-line-end="199">We are now able to perform Queries in the azure portal. But we want an azure function to query the resources for us. There are multiple ways to grant access. We will use client credentials for this, as the setup is pretty straight forward.</p>
<p class="has-line-data" data-line-start="200" data-line-end="202">Go to the Active Directory resource:<br>
<a href="https://portal.azure.com/#view/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/~/Overview">https://portal.azure.com/#view/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/~/Overview</a></p>
<p class="has-line-data" data-line-start="203" data-line-end="204">And then to <a href="https://portal.azure.com/#view/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/~/RegisteredApps">App Registrations</a></p>
<p class="has-line-data" data-line-start="205" data-line-end="206"><img src="/docs/images/AzureAD_AppRegistrations.png" alt=""></p>
<p class="has-line-data" data-line-start="207" data-line-end="208">Click on <code>+ New registration</code> to create a new one.</p>
<p class="has-line-data" data-line-start="209" data-line-end="212">Give a meaningful name.<br>
Supported account types: <code>Accounts in this organizational directory only (Standardverzeichnis only - Single tenant)</code> (default)<br>
Redirect URI (optional): ignore this one.</p>
<p class="has-line-data" data-line-start="213" data-line-end="214">Hit <code>Register</code> and you will be redirected to the new app registration.</p>
<p class="has-line-data" data-line-start="215" data-line-end="216">Take a note of the Application (client) ID and the Directory (tenant) ID as you will need them later.</p>
<p class="has-line-data" data-line-start="217" data-line-end="218"><img src="/docs/images/AppRegistrationIds.png" alt=""></p>
<p class="has-line-data" data-line-start="219" data-line-end="221">On the left menu, go to Certificates &amp; secrets.<br>
Create a client secret.</p>
<p class="has-line-data" data-line-start="222" data-line-end="224"><img src="/docs/images/create_client_secret_1.png" alt=""><br>
Enter a description and Expiracy.</p>
<blockquote>
<p class="has-line-data" data-line-start="224" data-line-end="225">Remember that you need to refresh this from time to time. That is the nature of client secrets.</p>
</blockquote>
<p class="has-line-data" data-line-start="226" data-line-end="227"><img src="/docs/images/create_client_secret_2.png" alt=""></p>
<p class="has-line-data" data-line-start="228" data-line-end="229">Keep note of the Value as you will need this later.</p>
<p class="has-line-data" data-line-start="230" data-line-end="231">We now need to perform one final step. Giving this new app registration access to our Log Analytics Workspace.</p>
<p class="has-line-data" data-line-start="232" data-line-end="233"><img src="/docs/images/log_analytics_workspace_iam.png" alt=""></p>
<p class="has-line-data" data-line-start="234" data-line-end="235">Click Add and Add role assignment.</p>
<p class="has-line-data" data-line-start="236" data-line-end="238">Choose the Contributor role and hit next.<br>
Click on select members.</p>
<p class="has-line-data" data-line-start="239" data-line-end="240"><img src="/docs/images/role_assignment_weirdo.png" alt=""></p>
<p class="has-line-data" data-line-start="241" data-line-end="242">Now comes a pretty weird part. On the right side there is a text box. You need to type in the name of your recently created app resource in order for it to be shown.</p>
<p class="has-line-data" data-line-start="243" data-line-end="246"><img src="/docs/images/smelly.png" alt=""><br>
Click on the item to select it and then the blue select button on the bottom right corner.<br>
<img src="/docs/images/review_and_assign.png" alt=""></p>
<p class="has-line-data" data-line-start="247" data-line-end="248">Hit review + assign.</p>
<p class="has-line-data" data-line-start="249" data-line-end="250">Done.</p>
<h2 class="code-line" data-line-start=251 data-line-end=252><a id="Write_the_code_251"></a>Write the code</h2>
<p class="has-line-data" data-line-start="253" data-line-end="254">We will use three Nuget Packages.</p>
<ul>
<li class="has-line-data" data-line-start="254" data-line-end="255">Azure.Identity (to use our client credentials and authorize)</li>
<li class="has-line-data" data-line-start="255" data-line-end="256">Azure.Monitor.Query (to query the logs)</li>
<li class="has-line-data" data-line-start="256" data-line-end="258">MailKit (to send emails)</li>
</ul>
<p class="has-line-data" data-line-start="258" data-line-end="259">The code is very straight forward, so I will not document it here again.</p>
<h2 class="code-line" data-line-start=260 data-line-end=261><a id="Deploy_Azure_function_260"></a>Deploy Azure function</h2>
<p class="has-line-data" data-line-start="262" data-line-end="263">There are multiple ways to deploy an azure function.</p>
<p class="has-line-data" data-line-start="264" data-line-end="265">In this example I will deploy it from within Visual Studio.</p>
<p class="has-line-data" data-line-start="266" data-line-end="268">From your Solution explorer, right click the project and hit publish.<br>
<img src="/docs/images/publish_from_proj.png" alt=""></p>
<p class="has-line-data" data-line-start="269" data-line-end="271">Select Azure and Next.<br>
Select Azure Function App (Linux).</p>
<p class="has-line-data" data-line-start="272" data-line-end="274">Click the green plus icon to create a new azure function.<br>
<img src="/docs/images/add_new_az_func.png" alt=""></p>
<p class="has-line-data" data-line-start="275" data-line-end="276">Fill in everything as you need it and hit Create.</p>
<p class="has-line-data" data-line-start="277" data-line-end="278">Hit Finish and Close.</p>
<p class="has-line-data" data-line-start="279" data-line-end="280">Now we have a publish profile. Hit Publish and Visual Studio will deploy the app.</p>
<p class="has-line-data" data-line-start="281" data-line-end="282"><img src="/docs/images/publish.png" alt=""></p>
<h2 class="code-line" data-line-start=283 data-line-end=284><a id="Configure_Azure_Function_283"></a>Configure Azure Function</h2>
<p class="has-line-data" data-line-start="285" data-line-end="286">The last thing we need to do is configuring the freshly published Azure Function. This will be done inside the azure portal.</p>
<p class="has-line-data" data-line-start="287" data-line-end="288"><img src="/docs/images/az_func_config.png" alt=""></p>
<p class="has-line-data" data-line-start="289" data-line-end="290">Add the following settings:</p>
<table class="table table-striped table-bordered">
<thead>
<tr>
<th>Setting</th>
<th style="text-align:left">Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>ReportReceipents</td>
<td style="text-align:left">semicolon separated list of emails</td>
</tr>
<tr>
<td>SenderEmail</td>
<td style="text-align:left">Email address from which the email should be sent</td>
</tr>
<tr>
<td>SenderName</td>
<td style="text-align:left">Email Sender name</td>
</tr>
<tr>
<td>SmtpServer</td>
<td style="text-align:left">smtp server host for email (outgoing)</td>
</tr>
<tr>
<td>SmtpPort</td>
<td style="text-align:left">smtp server port (outgoing)</td>
</tr>
<tr>
<td>EnableSsl</td>
<td style="text-align:left">whether to enable ssl or not</td>
</tr>
<tr>
<td>SmtpUsername</td>
<td style="text-align:left">smtp server username</td>
</tr>
<tr>
<td>SmtpPassword</td>
<td style="text-align:left">smtp server password</td>
</tr>
<tr>
<td>EmailSubject</td>
<td style="text-align:left">email subject</td>
</tr>
<tr>
<td>LogWorkspaceId</td>
<td style="text-align:left">log workspace id (noted before)</td>
</tr>
<tr>
<td>TenantId</td>
<td style="text-align:left">app registration tenant id (noted before)</td>
</tr>
<tr>
<td>ClientID</td>
<td style="text-align:left">app registration client id (noted before)</td>
</tr>
<tr>
<td>ClientSecret</td>
<td style="text-align:left">app registration secret (noted before)</td>
</tr>
</tbody>
</table>
<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script></body></html>